<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partners Directory - GEF 7 Partners Contract Tracking</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        :root {
            --unep-blue: #1e88e5;
            --unep-dark-blue: #1565c0;
            --component-1: #4e73df;
            --component-2: #1cc88a;
            --component-3: #f6c23e;
            --component-4: #36b9cc;
            --component-5: #858796;
        }
        
        .text-unep {
            color: var(--unep-blue) !important;
        }
        
        .bg-unep {
            background-color: var(--unep-blue) !important;
            color: white !important;
        }
        
        .bg-unep-subtle {
            background-color: rgba(30, 136, 229, 0.1) !important;
        }
        
        .btn-unep {
            background-color: var(--unep-blue);
            color: white;
            border: none;
        }
        
        .btn-unep:hover {
            background-color: var(--unep-dark-blue);
            color: white;
        }
        
        .btn-outline-unep {
            color: var(--unep-blue);
            border-color: var(--unep-blue);
        }
        
        .btn-outline-unep:hover {
            background-color: var(--unep-blue);
            color: white;
        }
        
        .card-unep {
            border-color: var(--unep-blue);
        }
        
        .progress-bar.bg-success {
            background-color: var(--component-2) !important;
        }
        
        .progress-bar.bg-warning {
            background-color: var(--component-3) !important;
        }
        
        .progress-bar.bg-danger {
            background-color: #e74a3b !important;
        }
        
        .partner-avatar {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .component-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        .progress-container {
            min-width: 120px;
        }
        
        .risk-indicator {
            font-size: 1.1rem;
        }
        
        .partner-row:hover {
            background-color: rgba(30, 136, 229, 0.04) !important;
            transform: translateX(2px);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .budget-info {
            min-width: 80px;
        }
        
        .timeline-info {
            min-width: 100px;
        }
        
        .text-1 { color: var(--component-1) !important; }
        .text-2 { color: var(--component-2) !important; }
        .text-3 { color: var(--component-3) !important; }
        .text-4 { color: var(--component-4) !important; }
        .text-5 { color: var(--component-5) !important; }
        
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 0.875rem;
            }
            
            .btn-group-sm .btn {
                padding: 0.25rem 0.5rem;
            }
        }
        
        .navbar-dark.bg-unep {
            background: linear-gradient(135deg, var(--unep-blue) 0%, var(--unep-dark-blue) 100%) !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-unep sticky-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="index.html">
                <div class="bg-white rounded p-1 me-2">
                    <i class="bi bi-tree-fill text-unep fs-4"></i>
                </div>
                <span class="h5 mb-0">GEF 7 Partners Contract Tracking</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="bi bi-speedometer2 me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle active" href="#" id="componentsDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-grid me-1"></i>Components
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" data-component="COMP1">
                                <i class="bi bi-map text-1 me-2"></i>
                                Component 1: Land Use Planning
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-component="COMP2">
                                <i class="bi bi-tools text-2 me-2"></i>
                                Component 2: Management Interventions
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-component="COMP3">
                                <i class="bi bi-people-fill text-3 me-2"></i>
                                Component 3: Community Empowerment
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-component="COMP4">
                                <i class="bi bi-lightbulb text-4 me-2"></i>
                                Component 4: Knowledge Management
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-component="COMP5">
                                <i class="bi bi-gear text-5 me-2"></i>
                                Component 5: Program Coordination
                            </a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="partners.html">
                            <i class="bi bi-building me-1"></i>Partners
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="reports.html">
                            <i class="bi bi-file-earmark-text me-1"></i>Reports
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="settingsDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person me-1"></i>Admin
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#">
                                <i class="bi bi-person-circle me-2"></i>Profile
                            </a></li>
                            <li><a class="dropdown-item" href="#">
                                <i class="bi bi-shield-check me-2"></i>Security
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#">
                                <i class="bi bi-box-arrow-right me-2"></i>Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-3">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h2 text-unep fw-bold">Partners Directory</h1>
                <p class="text-muted mb-0">Complete overview of all project partners</p>
            </div>
            <div class="d-flex align-items-center">
                <span class="badge bg-unep fs-6" id="totalPartnersBadge">Loading...</span>
            </div>
        </div>

        <!-- Filtres et Recherche -->
        <div class="card card-unep shadow-sm mb-4">
            <div class="card-body">
                <form method="get" class="row g-3 align-items-end" id="filterForm">
                    <div class="col-md-3">
                        <label class="form-label small text-muted mb-1">Search Partners</label>
                        <input type="text" 
                               class="form-control" 
                               name="search" 
                               id="searchInput"
                               placeholder="Search by name, component...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted mb-1">Filter by Component</label>
                        <select class="form-select" name="component" id="componentFilter">
                            <option value="">All Components</option>
                            <option value="COMP1">Component 1: Land Use Planning</option>
                            <option value="COMP2">Component 2: Management Interventions</option>
                            <option value="COMP3">Component 3: Community Empowerment</option>
                            <option value="COMP4">Component 4: Knowledge Management</option>
                            <option value="COMP5">Component 5: Program Coordination</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted mb-1">Filter by Status</label>
                        <select class="form-select" name="status" id="statusFilter">
                            <option value="">All Statuses</option>
                            <option value="VPM">Validated by PM</option>
                            <option value="RP">Under Review</option>
                            <option value="NR">Not Received</option>
                            <option value="NV">Not Validated</option>
                            <option value="R">Received</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-unep w-100" id="applyFiltersBtn">
                            <i class="bi bi-funnel me-1"></i>Apply Filters
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Statistiques des Filtres -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card card-unep shadow-sm h-100">
                    <div class="card-header bg-white border-0">
                        <h6 class="mb-0 text-unep">Components Distribution</h6>
                    </div>
                    <div class="card-body" id="componentStatsBody">
                        <!-- Dynamically populated -->
                        <div class="text-center py-4">
                            <div class="spinner-border text-unep" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card card-unep shadow-sm h-100">
                    <div class="card-header bg-white border-0">
                        <h6 class="mb-0 text-unep">Report Status Overview</h6>
                    </div>
                    <div class="card-body" id="statusStatsBody">
                        <!-- Dynamically populated -->
                        <div class="text-center py-4">
                            <div class="spinner-border text-unep" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Liste des Partenaires -->
        <div class="card card-unep shadow-sm">
            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-unep">Partners List</h5>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-unep dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-download me-1"></i>Export
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" id="exportCSVBtn"><i class="bi bi-filetype-csv me-2"></i>CSV Export</a></li>
                        <li><a class="dropdown-item" href="#" id="exportExcelBtn"><i class="bi bi-file-earmark-excel me-2"></i>Excel Export</a></li>
                    </ul>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="ps-4">Partner</th>
                                <th>Component</th>
                                <th>Budget</th>
                                <th>Progress</th>
                                <th>Timeline</th>
                                <th>Reports</th>
                                <th>Risk</th>
                                <th class="pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="partnersTableBody">
                            <!-- Dynamically populated -->
                            <tr>
                                <td colspan="8" class="text-center py-5">
                                    <div class="spinner-border text-unep" role="status">
                                        <span class="visually-hidden">Loading partners...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card card-unep shadow-sm">
                    <div class="card-body">
                        <h6 class="text-unep mb-3">Quick Actions</h6>
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-outline-unep btn-sm" id="addPartnerBtn">
                                <i class="bi bi-plus-circle me-1"></i>Add New Partner
                            </button>
                            <button class="btn btn-outline-unep btn-sm" id="sendBulkMessagesBtn">
                                <i class="bi bi-envelope me-1"></i>Send Bulk Messages
                            </button>
                            <button class="btn btn-outline-unep btn-sm" id="exportAllDataBtn">
                                <i class="bi bi-download me-1"></i>Export All Data
                            </button>
                            <button class="btn btn-outline-unep btn-sm" id="printListBtn">
                                <i class="bi bi-printer me-1"></i>Print List
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Données -->
    <script src="data.js"></script>
    
    <!-- Logique de la page Partners -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialisation
        loadPageData();
        
        // Événements
        document.getElementById('applyFiltersBtn').addEventListener('click', filterPartners);
        document.getElementById('searchInput').addEventListener('input', debounce(filterPartners, 500));
        document.getElementById('componentFilter').addEventListener('change', filterPartners);
        document.getElementById('statusFilter').addEventListener('change', filterPartners);
        
        // Export
        document.getElementById('exportCSVBtn').addEventListener('click', exportToCSV);
        document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
        
        // Quick actions
        document.getElementById('addPartnerBtn').addEventListener('click', addNewPartner);
        document.getElementById('sendBulkMessagesBtn').addEventListener('click', sendBulkMessages);
        document.getElementById('exportAllDataBtn').addEventListener('click', exportAllData);
        document.getElementById('printListBtn').addEventListener('click', printList);
        
        // Navigation des composants
        document.querySelectorAll('#componentsDropdown .dropdown-item[data-component]').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const component = this.getAttribute('data-component');
                document.getElementById('componentFilter').value = component;
                filterPartners();
            });
        });
        
        // Fonctions
        function loadPageData() {
            // Mettre à jour le badge du nombre total
            const totalPartners = DataUtils.getTotalPartners();
            document.getElementById('totalPartnersBadge').textContent = `${totalPartners} Partners`;
            
            // Remplir les statistiques des composants
            const componentStats = DataUtils.getComponentStats();
            const componentStatsHtml = componentStats.map(stat => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="small">
                        <i class="bi bi-circle-fill me-2 text-${stat.component.charAt(4)}"></i>
                        ${stat.component}
                    </span>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-light text-dark me-2">${stat.count}</span>
                        <small class="text-muted">${stat.avg_progress.toFixed(1)}% avg</small>
                    </div>
                </div>
            `).join('');
            document.getElementById('componentStatsBody').innerHTML = componentStatsHtml;
            
            // Remplir les statistiques des statuts
            const statusStats = DataUtils.getStatusStats();
            const statusStatsHtml = statusStats.map(stat => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="small">
                        <i class="bi bi-file-earmark-text me-2"></i>
                        ${stat.report_status}
                    </span>
                    <span class="badge ${getStatusBadgeClass(stat.report_status)}">
                        ${stat.count}
                    </span>
                </div>
            `).join('');
            document.getElementById('statusStatsBody').innerHTML = statusStatsHtml;
            
            // Remplir le tableau des partenaires
            renderPartnersTable(DataUtils.getPartners());
            
            // Initialiser les tooltips
            initializeTooltips();
        }
        
        function renderPartnersTable(partners) {
            const tbody = document.getElementById('partnersTableBody');
            
            if (partners.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <i class="bi bi-search text-muted fs-1 d-block mb-3"></i>
                            <h5 class="text-muted">No partners found</h5>
                            <p class="text-muted mb-0">Try adjusting your search filters</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const rowsHtml = partners.map(partner => {
                // Calculer le temps restant (simplifié)
                const today = new Date();
                const endDate = new Date(partner.contract_end_date || '2024-12-31');
                const timeRemaining = Math.max(0, Math.ceil((endDate - today) / (1000 * 60 * 60 * 24)));
                const timeElapsedPercentage = 70; // Valeur fictive pour la démo
                
                // Calculer le risque (simplifié)
                const risk = partner.progression - timeElapsedPercentage;
                const riskLevel = getRiskLevel(risk);
                
                return `
                <tr class="partner-row" data-partner-id="${partner.id}">
                    <td class="ps-4">
                        <div class="d-flex align-items-center">
                            <div class="partner-avatar bg-unep-subtle rounded-circle p-2 me-3">
                                <i class="bi bi-building text-unep"></i>
                            </div>
                            <div>
                                <div class="fw-bold text-dark">${partner.displayName}</div>
                                <small class="text-muted">
                                    ${partner.extension_needed ? 
                                        '<i class="bi bi-clock-history text-warning me-1"></i>Extension needed' : 
                                        '<i class="bi bi-check-circle text-success me-1"></i>On track'}
                                </small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-light text-dark component-badge">
                            ${partner.componentDisplay}
                        </span>
                    </td>
                    <td>
                        <div class="budget-info">
                            <div class="fw-bold">$${partner.amount_committed.toLocaleString()}</div>
                            <small class="text-muted">
                                Available: $${partner.budget_available.toLocaleString()}
                            </small>
                        </div>
                    </td>
                    <td>
                        <div class="progress-container">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="fw-bold ${getProgressTextClass(partner.progression)}">
                                    ${partner.progression}%
                                </small>
                                <small class="text-muted">${timeElapsedPercentage}% time</small>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar ${getProgressBarClass(partner.progression)}" 
                                     style="width: ${partner.progression}%"></div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="timeline-info">
                            <small class="d-block text-muted">Ends: ${partner.contract_end_date || 'N/A'}</small>
                            <small class="${timeRemaining < 90 ? 'text-warning' : 'text-success'}">
                                ${timeRemaining} days left
                            </small>
                        </div>
                    </td>
                    <td>
                        <span class="badge ${getStatusBadgeClass(partner.report_status_display)}">
                            ${partner.report_status_display}
                        </span>
                    </td>
                    <td>
                        <span class="risk-indicator" title="Progress vs Time: ${risk.toFixed(1)}%">
                            <i class="bi ${getRiskIcon(riskLevel)}"></i>
                        </span>
                    </td>
                    <td class="pe-4">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-unep view-details-btn" title="View Details" data-partner-id="${partner.id}">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-outline-secondary send-message-btn" title="Send Message" data-partner-id="${partner.id}">
                                <i class="bi bi-envelope"></i>
                            </button>
                            <button class="btn btn-outline-info schedule-review-btn" title="Schedule Review" data-partner-id="${partner.id}">
                                <i class="bi bi-calendar-plus"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
            
            tbody.innerHTML = rowsHtml;
            
            // Ajouter les événements aux boutons d'actions
            document.querySelectorAll('.view-details-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const partnerId = this.getAttribute('data-partner-id');
                    viewPartnerDetails(partnerId);
                });
            });
            
            document.querySelectorAll('.send-message-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const partnerId = this.getAttribute('data-partner-id');
                    sendMessage(partnerId);
                });
            });
            
            document.querySelectorAll('.schedule-review-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const partnerId = this.getAttribute('data-partner-id');
                    scheduleReview(partnerId);
                });
            });
            
            // Ajouter les événements aux lignes
            document.querySelectorAll('.partner-row').forEach(row => {
                row.addEventListener('click', function(e) {
                    if (!e.target.closest('a') && !e.target.closest('button')) {
                        const partnerId = this.getAttribute('data-partner-id');
                        viewPartnerDetails(partnerId);
                    }
                });
            });
            
            // Réinitialiser les tooltips
            initializeTooltips();
        }
        
        function filterPartners() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const componentFilter = document.getElementById('componentFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filteredPartners = DataUtils.getPartners();
            
            // Filtrer par recherche
            if (searchTerm) {
                filteredPartners = filteredPartners.filter(partner =>
                    partner.displayName.toLowerCase().includes(searchTerm) ||
                    partner.componentDisplay.toLowerCase().includes(searchTerm)
                );
            }
            
            // Filtrer par composant
            if (componentFilter) {
                filteredPartners = filteredPartners.filter(partner => 
                    partner.component === componentFilter
                );
            }
            
            // Filtrer par statut
            if (statusFilter) {
                filteredPartners = filteredPartners.filter(partner => 
                    partner.report_status === statusFilter
                );
            }
            
            renderPartnersTable(filteredPartners);
        }
        
        function getProgressBarClass(progress) {
            if (progress >= 70) return 'bg-success';
            if (progress >= 40) return 'bg-warning';
            return 'bg-danger';
        }
        
        function getProgressTextClass(progress) {
            if (progress >= 70) return 'text-success';
            if (progress >= 40) return 'text-warning';
            return 'text-danger';
        }
        
        function getStatusBadgeClass(status) {
            switch(status) {
                case 'Validated by PM': return 'bg-success';
                case 'Under Review': return 'bg-warning text-dark';
                case 'Not Received': return 'bg-danger';
                case 'Not Validated': return 'bg-info';
                case 'Received': return 'bg-primary';
                default: return 'bg-secondary';
            }
        }
        
        function getRiskLevel(risk) {
            if (risk < -20) return 'high';
            if (risk < -10) return 'medium';
            return 'low';
        }
        
        function getRiskIcon(riskLevel) {
            switch(riskLevel) {
                case 'high': return 'bi-exclamation-triangle-fill text-danger';
                case 'medium': return 'bi-exclamation-circle-fill text-warning';
                default: return 'bi-check-circle-fill text-success';
            }
        }
        
        function initializeTooltips() {
            const riskIndicators = document.querySelectorAll('.risk-indicator');
            riskIndicators.forEach(indicator => {
                new bootstrap.Tooltip(indicator);
            });
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Fonctions d'action
        function viewPartnerDetails(partnerId) {
            const partner = DataUtils.getPartnerById(parseInt(partnerId));
            if (partner) {
                alert(`Viewing details for: ${partner.displayName}\nComponent: ${partner.componentDisplay}\nProgress: ${partner.progression}%\nStatus: ${partner.report_status_display}`);
                // Dans une vraie application, vous redirigeriez vers une page de détails
                // window.location.href = `partner-details.html?id=${partnerId}`;
            }
        }
        
        function sendMessage(partnerId) {
            const partner = DataUtils.getPartnerById(parseInt(partnerId));
            if (partner) {
                alert(`Sending message to: ${partner.displayName}`);
            }
        }
        
        function scheduleReview(partnerId) {
            const partner = DataUtils.getPartnerById(parseInt(partnerId));
            if (partner) {
                alert(`Scheduling review for: ${partner.displayName}`);
            }
        }
        
        function addNewPartner() {
            alert('Add New Partner feature would open a form here');
        }
        
        function sendBulkMessages() {
            alert('Bulk message feature would open here');
        }
        
        function exportAllData() {
            alert('Exporting all data...');
        }
        
        function printList() {
            window.print();
        }
        
        function exportToCSV() {
            alert('Exporting to CSV...');
            // Implémentation réelle ici
        }
        
        function exportToExcel() {
            alert('Exporting to Excel...');
            // Implémentation réelle ici
        }
    });
    </script>
</body>
</html>